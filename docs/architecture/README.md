# 架构说明

## 系统架构

### 1. 整体架构

```
+------------------+     +------------------+     +------------------+
|     前端层       |     |     后端层       |     |     AI服务层     |
|  Frontend Layer  |     |  Backend Layer   |     |   AI Services   |
+------------------+     +------------------+     +------------------+
| - Vue 3          |     | - Express        |     | - LangChain     |
| - TypeScript     |     | - Node.js        |     | - Deepseek API  |
| - Element Plus   |     | - MongoDB        |     | - RAG System    |
| - Pinia         |     | - TypeScript     |     | - Milvus        |
+------------------+     +------------------+     +------------------+
         ↑                       ↑                        ↑
         |                       |                        |
         ↓                       ↓                        ↓
+------------------+     +------------------+     +------------------+
|     基础设施      |     |     中间件       |     |     外部服务     |
| Infrastructure   |     |  Middleware     |     | External Services|
+------------------+     +------------------+     +------------------+
| - Nginx          |     | - 认证           |     | - Zilliz Cloud  |
| - Docker         |     | - 日志           |     | - MongoDB Atlas |
| - Redis          |     | - 缓存           |     | - Redis Cloud   |
+------------------+     +------------------+     +------------------+
```

### 2. 目录结构

```
project/
├── frontend/          # 前端代码
│   ├── src/
│   │   ├── components/  # 组件
│   │   ├── views/      # 页面
│   │   ├── stores/     # 状态管理
│   │   ├── services/   # 服务
│   │   ├── utils/      # 工具函数
│   │   ├── types/      # 类型定义
│   │   └── router/     # 路由
├── backend/           # 后端代码
│   ├── src/
│   │   ├── modules/    # 业务模块
│   │   ├── middlewares/# 中间件
│   │   ├── models/     # 数据模型
│   │   ├── services/   # 服务层
│   │   └── utils/      # 工具函数
├── docs/             # 文档
├── tests/            # 测试
└── scripts/          # 工具脚本
```

## 技术栈

### 1. 前端技术

1. 核心框架
   - Vue 3
   - TypeScript
   - Element Plus
   - Pinia

2. 工具链
   - Vite
   - ESLint
   - Prettier
   - Vitest

3. 功能模块
   - 编辑器
   - 时间线
   - 关系图谱
   - 数据可视化

### 2. 后端技术

1. 核心框架
   - Node.js
   - Express
   - TypeScript
   - MongoDB

2. 中间件
   - 认证
   - 验证
   - 日志
   - 缓存

3. 工具链
   - ESLint
   - Jest
   - PM2
   - Docker

### 3. AI服务

1. 框架
   - LangChain
   - RAG系统
   - 向量数据库

2. API集成
   - Deepseek API
   - Zilliz Cloud
   - MongoDB Atlas

## 核心模块

### 1. 剧本创作模块

1. 功能
   - 剧本编辑
   - AI辅助写作
   - 版本管理
   - 协同编辑

2. 技术实现
   - 富文本编辑器
   - 实时保存
   - WebSocket
   - 操作历史

### 2. 角色管理模块

1. 功能
   - 角色信息管理
   - 关系图谱
   - AI角色分析
   - 角色对话生成

2. 技术实现
   - 图数据库
   - 关系可视化
   - AI服务集成
   - 数据同步

### 3. 时间线模块

1. 功能
   - 事件管理
   - 时间轴展示
   - 关联分析
   - 冲突检测

2. 技术实现
   - 时间线组件
   - 拖拽排序
   - 数据验证
   - 实时更新

### 4. 线索系统

1. 功能
   - 线索管理
   - 分布优化
   - 难度平衡
   - 关联分析

2. 技术实现
   - 图数据结构
   - AI辅助分析
   - 可视化展示
   - 数据校验

## 数据流

### 1. 前端数据流

```
+-------------+     +-------------+     +-------------+
|    Views    | --> |   Stores    | --> |  Services   |
+-------------+     +-------------+     +-------------+
      ↑                   ↑                   ↑
      |                   |                   |
      ↓                   ↓                   ↓
+-------------+     +-------------+     +-------------+
| Components  | --> |   States    | --> |    API     |
+-------------+     +-------------+     +-------------+
```

### 2. 后端数据流

```
+-------------+     +-------------+     +-------------+
|   Routes    | --> | Controllers | --> |  Services   |
+-------------+     +-------------+     +-------------+
      ↑                   ↑                   ↑
      |                   |                   |
      ↓                   ↓                   ↓
+-------------+     +-------------+     +-------------+
| Middleware  | --> |   Models    | --> | Database   |
+-------------+     +-------------+     +-------------+
```

## 部署架构

### 1. 开发环境

```
+------------------+
|   开发工作站      |
+------------------+
| - Node.js        |
| - MongoDB        |
| - Redis          |
| - Docker         |
+------------------+
```

### 2. 测试环境

```
+------------------+     +------------------+
|   应用服务器      |     |   数据库服务器    |
+------------------+     +------------------+
| - Node.js        |     | - MongoDB       |
| - Redis          |     | - Redis         |
| - Nginx          |     | - Backup        |
+------------------+     +------------------+
```

### 3. 生产环境

```
+------------------+     +------------------+     +------------------+
|   负载均衡器      |     |   应用集群       |     |   数据库集群     |
+------------------+     +------------------+     +------------------+
| - Nginx          |     | - Node.js x N    |     | - MongoDB      |
| - SSL            |     | - Redis          |     | - Redis        |
| - 监控           |     | - Docker         |     | - 备份         |
+------------------+     +------------------+     +------------------+
```

## 安全架构

### 1. 认证授权

1. JWT认证
   - Token生成
   - 过期管理
   - 刷新机制
   - 安全存储

2. 权限控制
   - 角色管理
   - 资源访问
   - 操作审计
   - 数据隔离

### 2. 数据安全

1. 传输安全
   - HTTPS
   - API加密
   - WebSocket安全
   - 数据压缩

2. 存储安全
   - 数据加密
   - 备份策略
   - 访问控制
   - 审计日志

## 监控告警

### 1. 系统监控

1. 性能指标
   - CPU使用率
   - 内存占用
   - 磁盘IO
   - 网络流量

2. 应用指标
   - 响应时间
   - 错误率
   - 并发数
   - QPS

### 2. 业务监控

1. 用户指标
   - DAU
   - 使用时长
   - 功能使用
   - 转化率

2. AI服务指标
   - 调用量
   - 响应时间
   - 成功率
   - 质量评分

## 后续规划

### 1. 短期计划

1. 架构优化
   - 完成LangChain迁移
   - 优化数据结构
   - 提升性能
   - 完善监控

2. 功能增强
   - 完善核心功能
   - 优化用户体验
   - 增加测试覆盖
   - 补充文档

### 2. 中长期计划

1. 架构升级
   - 服务化改造
   - 容器化部署
   - 自动化运维
   - 智能运维

2. 功能扩展
   - 多语言支持
   - 协同功能
   - API开放
   - 生态建设 